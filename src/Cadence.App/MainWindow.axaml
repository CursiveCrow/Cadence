<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:Cadence.App"
        mc:Ignorable="d"
        x:Class="Cadence.App.MainWindow"
        Width="1000" Height="720"
        Title="Cadence â€” Score (time + structure)">

  <Design.DataContext>
    <vm:MainWindowViewModel/>
  </Design.DataContext>

  <Grid RowDefinitions="Auto,*">
    <StackPanel Orientation="Horizontal" Margin="8">
      <Button Content="Load Seed" Command="{Binding LoadSeedCommand}" Margin="0,0,8,0"/>
      <Button Content="Run Scheduler" Command="{Binding RunSchedulerCommand}" Margin="0,0,8,0"/>
      <CheckBox Content="Show Dependencies" IsChecked="{Binding ShowDependencies}" Margin="0,0,8,0"/>
      <CheckBox Content="Align by Schedule" IsChecked="{Binding AlignBySchedule}" Margin="0,0,8,0"/>
      <CheckBox Content="Edge Bundling" IsChecked="{Binding EdgeBundling}" Margin="0,0,8,0"/>
      <CheckBox Content="Critical Only" IsChecked="{Binding CriticalOnly}" />
    </StackPanel>

    <!-- Combined Score view -->
    <ScrollViewer Grid.Row="1">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/> <!-- Chords ribbon -->
          <RowDefinition Height="*"/>    <!-- Time staff -->
        </Grid.RowDefinitions>

        <!-- Chords ribbon (structural overlay) -->
        <ItemsControl Grid.Row="0" Items="{Binding Chords}" Margin="16,8,16,4">
          <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
              <StackPanel Orientation="Horizontal"/>
            </ItemsPanelTemplate>
          </ItemsControl.ItemsPanel>
          <ItemsControl.ItemTemplate>
            <DataTemplate>
              <Border CornerRadius="8" Padding="8" Margin="4" Background="#EEF">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <Ellipse Width="8" Height="8" Fill="#99A" VerticalAlignment="Center"/>
                  <TextBlock Text="{Binding Name}" />
                </StackPanel>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- Time staff with measures + notes -->
        <Grid Grid.Row="1" Margin="16">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Measure headers -->
            <RowDefinition Height="*"/>    <!-- Notes & overlay canvases -->
          </Grid.RowDefinitions>

          <!-- Measure headers -->
          <ItemsControl Grid.Row="0" Items="{Binding Measures}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <StackPanel Orientation="Horizontal"/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border BorderBrush="#CCC" BorderThickness="0,0,1,1" Padding="8" Margin="0,0,16,0">
                  <StackPanel>
                    <TextBlock Text="{Binding Label}" FontWeight="Bold"/>
                    <TextBlock Text="{Binding CapacityText}" />
                  </StackPanel>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <!-- Overlay: structural & dependency edges (drawn on top of notes) -->
          <ItemsControl Grid.Row="1" Items="{Binding Edges}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <Canvas/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Path Data="{Binding PathData}"
                      Stroke="{Binding Stroke}"
                      StrokeThickness="{Binding StrokeThickness}"
                      Opacity="{Binding Opacity}"
                      IsHitTestVisible="False"/>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <!-- Notes lane -->
          <ItemsControl Grid.Row="1" Items="{Binding VisibleNotes}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <Canvas Height="260"/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemContainerStyle>
              <Style Selector="ContentPresenter">
                <Setter Property="Canvas.Left" Value="{Binding CanvasLeft}"/>
                <Setter Property="Canvas.Top" Value="{Binding CanvasTop}"/>
              </Style>
            </ItemsControl.ItemContainerStyle>
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Button Background="Transparent" BorderThickness="0"
                        Command="{Binding DataContext.SelectNoteCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                        CommandParameter="{Binding}">
                  <Border CornerRadius="6" Padding="6" Background="{Binding Color}" BorderBrush="#333" BorderThickness="1"
                          Width="{Binding Width}" Opacity="{Binding Opacity}"
                          AutomationProperties.Name="{Binding A11yName}"
                          AutomationProperties.HelpText="Press Enter or Space to select this note and highlight its forward path to the piece.">
                    <StackPanel>
                      <TextBlock Text="{Binding Title}" FontWeight="SemiBold"/>
                      <TextBlock Text="{Binding DurationText}" FontSize="11"/>
                      <TextBlock Text="{Binding ChordName}" FontSize="11" Foreground="#555"/>
                    </StackPanel>
                  </Border>
                </Button>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <!-- Spacer to ensure scrollable width matches the timeline -->
          <Rectangle Grid.Row="1" Width="{Binding TimelineWidth}" Height="1" Opacity="0"/>
        </Grid>
      </Grid>
    </ScrollViewer>
  </Grid>
</Window>
